var Color = require('color');

/*The following is a transcript of the Unity color backlight algorithm that can be found here
http://bazaar.launchpad.net/~ubuntu-branches/ubuntu/vivid/unity/vivid/view/head:/launcher/LauncherIcon.cpp
and is licensed under GPL 3*/
function colorForIcon(icon)
{
  var rtotal = 0;
  var gtotal = 0;
  var btotal = 0;
  var total = 0;
  
  for(var i = 0; i < icon.data.length; i += 4)
  {
    var r = icon.data[i + 0];
    var g = icon.data[i + 1];
    var b = icon.data[i + 2];
    var a = icon.data[i + 3];

    var saturation = (Math.max(r, Math.max(g, b)) - Math.min(r, Math.min(g, b))) / 255.0;
    var relevance = .1 + .9 * (a / 255.0) * saturation;

    rtotal += (r * relevance);
    gtotal += (g * relevance);
    btotal += (b * relevance);

    total += relevance * 255;
  }
  
  var color = new Color({r: rtotal / total * 255, g: gtotal / total * 255, b:btotal / total * 255});
  
  if(color.saturationv() > 0.15 * 100)
    color = color.saturationv(0.75 * 100); //values slightly tweaked here from the original
  
  color = color.value(0.8 * 100);

  return color;
}

module.exports.colorForIcon = colorForIcon;
